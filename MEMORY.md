# MEMORY.md - 持久化记忆

**最后精简：** 2026-02-18 17:10  
**精简策略：** 保留核心规则 + 终极目标 + 最近项目，历史内容归档到 `MEMORY_ARCHIVE.md`

---

## 🔴🔴🔴 **永久核心规则（重启后必须遵守）**

### 🚨 **规则 1：永远不要考虑时间成本（2026-02-16 22:36）**
**重要等级：** 🔴 最高 | **优先级：** P0（不可违背）

**核心：** 所有项目开发，永远不要考虑时间成本！
- ✅ 正确第一，速度第二
- ✅ 质量第一，效率第二
- ❌ 禁止：跳过测试/文档/可行性调查
- ❌ 禁止：使用硬编码/魔法值
- ✅ 推荐：充分测试（覆盖率≥80%）、完整文档

**详细文档：** `memory/RULE_NEVER_CONSIDER_TIME_COST.md`

---

### 🚨 **规则 2：四轮专家会议流程（启动前必做）**
**重要等级：** 🔴 最高 | **优先级：** P0

**流程：**
1. 第一轮：技术方案分析
2. 第二轮：安全与崩溃防护
3. 第三轮：收益与最优化分析（不含时间成本）
4. 第四轮：开发规范制定

**时间限制：** 单轮会议 ≤9 分钟（避免 OpenClaw 超时）

---

### 🚨 **规则 3：可行性研究调查（方案决定后必做）**
**重要等级：** 🔴 最高 | **优先级：** P0

**检查清单：**
- [ ] 技术可行性
- [ ] 外部依赖调查
- [ ] 资源可用性
- [ ] 风险评估（至少 3 个失败场景）

---

### 🚨 **规则 4：风险评估与备选方案（方案决定后必做）**
**重要等级：** 🔴 最高 | **优先级：** P0

**必须包含：**
- 至少 3 个失败场景
- 至少 1 个备选方案
- 回滚计划

---

### 🚨 **规则 5：资源利用效率最大化（2026-02-18 11:06）**
**重要等级：** 🔴 高 | **优先级：** P1

**核心：** 最大化利用现有资源，避免重复造轮子！
- ✅ 优先复用现有组件（MVP JARVIS、V2 学习系统等）
- ✅ 优先使用 OpenClaw 工具
- ✅ 优先使用免费资源（NVIDIA 免费 API）
- ❌ 禁止重复造轮子

---

### 🚨 **规则 6：输出格式化规范（2026-02-18 11:21）**
**重要等级：** 🔴 最高 | **优先级：** P0

**5 条 P0 铁律：**
1. **总结先行** - 第 1-2 行必须有"一句话总结"
2. **重点加粗** - 所有数字、选项、关键结论必须加粗
3. **强制留白** - 段落间至少 1 行空行，大章节间至少 2 行
4. **表格优先** - 超过 3 项对比必须用表格
5. **代码独立** - 所有命令/配置必须用 ``` 包裹

**自检清单：** 5 项全部为"是"才能输出

**详细文档：** `workspace/RULE_OUTPUT_FORMATTING.md`

---

## 🌟 **终极目标：超越 JARVIS 的全能 AI**

**⚠️ 重要性：极高 🔴** | **⚡ 优先级：最高（战略方向）**

### 🎯 **终极目标：**
成为超越钢铁侠贾维斯的个人 AI，无所不能，能帮我做任何事情

### 🚀 **MVP 全能 AI 系统（1 个月）：**
```
MVP 全能 AI 系统
├── 流式 Gateway（P1，端口 8001）✅
├── Agent Engine ⭐
│   ├── SOUL Manager（人格）
│   ├── Memory Manager（长期记忆 + 上下文回忆）
│   └── Context Manager（对话上下文）
├── Tool Engine（P2 + OpenClaw 工具）⭐
│   ├── web_search
│   ├── web_fetch
│   └── exec（Shell 命令）
└── 配置系统（P4）✅
```

### 📊 **6 个 API Provider（统一 Gateway 架构）**
| Provider | 模型 | 延迟 | 特点 | 用途 |
|----------|------|------|------|------|
| **zhipu** | glm-4-flash | 🥇 1.03s | 最快，200K 上下文 | 实时对话 |
| **hunyuan** | hunyuan-lite | 🥈 1.20s | 256K 上下文，**无 RPM** ⭐ | 大批量任务 |
| **nvidia1** | z-ai/glm4.7 | 7.17s | 深度思考 | 复杂推理 |
| **nvidia2** | z-ai/glm4.7 | 🥉 2.68s | 平衡型 ⭐ | 日常使用 |
| **nvidia3** | z-ai/glm4.7 | 待测 | 第 3 备用 | 降级备用 |
| **siliconflow** | bge-large-zh | 0.10s | Embeddings 专用 | 向量生成 |

**Gateway 服务：** `ws://127.0.0.1:8001`  
**配置管理：** `openclaw_async_architecture/API_CONFIG_FINAL.json`

---

## 🚀 **当前项目：知识库系统（Knowledge Base）**

**状态：** ✅ **统一 Gateway 架构切换完成（2026-02-18）**  
**GitHub：** https://github.com/zhoushibo/knowledge-base

### ✅ 完成成果
| 指标 | 切换前 | 切换后 | 改善 |
|------|--------|--------|------|
| API Key 数量 | 3 个（分散） | 0 个（集中） | 100% 集中 |
| 可用 Provider | 1 个（NVIDIA） | 6 个（Gateway） | 增加 5 个 |
| Embeddings 延迟 | ~7 秒 | ~0.1 秒 | **70 倍提升** ⚡ |
| 配置维护点 | 3 处 | 1 处 | 减少 67% |

### 🎯 核心架构
```
Gateway 服务 (8001) → 6 个 Provider
    ↑
    ├─ knowledge_base (gateway_client.py) - WebSocket 对话
    └─ SiliconFlow API (直接调用) - Embeddings 生成（1024 维）
```

### 📝 技术细节
**Embedding 分段策略：**
- SiliconFlow 限制：512 tokens
- 实际阈值：300 字符/段
- 分割方式：按句子分割
- 合并方式：平均 pooling

**缓存机制：**
- SHA256 哈希作为缓存键
- JSON 文件存储：`data/embedding_cache.json`
- Fallback：API 失败时返回零向量

### 📄 详细文档
- `knowledge_base/docs/FINAL_MIGRATION_REPORT.md` - 完整切换报告
- `knowledge_base/docs/GATEWAY_MIGRATION.md` - 迁移指南

---

## 🧠 记忆系统设计

### 设计原则
- **自动回忆：** 用户提到"我们做过/说过/写过"时，自动搜索相关记忆
- **知识积累：** 每个项目细节、技术决策、代码实现都记录
- **上下文保持：** 跨会话保持上下文，避免重复劳动

### 使用规则
以下情况必须执行 `memory_search`：
1. 用户说"我们做过×××"
2. 用户说"昨天/上次×月×日"
3. 用户提到"代码在哪"、"之前写的"
4. 用户问我"记得吗"
5. 开始项目前，先搜索是否有类似项目

### 文件结构
- **MEMORY.md** - 核心规则 + 终极目标 + 当前项目（<20000 字符）
- **MEMORY_ARCHIVE.md** - 历史项目归档（钉钉机器人等）
- **memory/YYYY-MM-DD.md** - 每日详细记录

---

## 📊 用户偏好

### Token 使用预警
- **阈值：** > 80% 自动通知
- **触发条件：** 主会话状态显示 > 80%
- **提示方式：** 消息开头显示 `⚠️ Token 使用量：85%`

### exec 命令模式
- **短命令（<30 秒）：** `exec pty=true` - 立即输出 ⭐
- **长期服务（>1 分钟）：** `exec background=true` - 后台运行

---

## 🔗 重要链接

| 项目 | 链接 |
|------|------|
| **知识库系统** | https://github.com/zhoushibo/knowledge-base |
| **Gateway 服务** | `openclaw_async_architecture/streaming-service/src/gateway.py` |
| **API 配置** | `openclaw_async_architecture/API_CONFIG_FINAL.json` |

---

*最后更新：2026-02-18 17:10*  
*历史内容已归档到 `MEMORY_ARCHIVE.md`*
